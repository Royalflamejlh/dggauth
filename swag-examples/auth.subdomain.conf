server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name auth.*;

    include /config/nginx/ssl.conf;
    client_max_body_size 0;

    location / {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        # Upstream auth service (container name + port)
        set $upstream_auth destiny-auth;
        set $upstream_proto http;
        set $upstream_port 8000;

        # Optional: allow the app frontend to call auth APIs with cookies
        # Set your app domain; this builds https://<base-domain>
        set $domain $host;
        if ($host ~* "^[^.]+\.([^.]+\..+)$") {
            set $domain $1;
        }
        set $app_origin https://$domain;

        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $app_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Headers "Content-Type,Authorization,X-Requested-With" always;
            add_header Access-Control-Allow-Methods "GET,POST,OPTIONS" always;
            return 204;
        }

        add_header Access-Control-Allow-Origin $app_origin always;
        add_header Access-Control-Allow-Credentials "true" always;

        proxy_pass $upstream_proto://$upstream_auth:$upstream_port;
    }
}
